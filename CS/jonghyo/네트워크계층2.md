# 네트워크 계층2

### NAT

- IPv4는 약 40억개의 주소공간이 있음.
- 한창 공간이 부족했지만 이 공간을 공유하며 살아가기 위해 **NAT**가 있음.
- NAT를 통해 내부 IP 주소를 외부로 나갈 때 게이트 웨이 라우터 IP 주소로 변환 시켜준다. 바깥에 있는게 들어올 땐 그대로 다시 변환.

### NAT : 네트워크 주소 변환

1. 호스트 10.0.0.1에서 데이터 그램을 128.119.40.186. 80 으로 보낸다.
    1. 위의 패킷이 그대로 라우터를 통해 나가면 안된다. why?) 유일한 IP주소가 아니기 때문.
2. 들어온 패킷이 나갈 땐 소스 주소를 라우터의 IP주소로 변환해주고 포트 번호 변환해 주고 패킷을 전달해 줍니다.
    1. 위와 같이 변환 한 것을 NAT transtation table에 저장시킨다.
3. 목적지를 갔다가 돌아오는 return 패킷의 포트번호를 보고 NAT transtation table을 보고 어디로 보내줘야 할지 결정해 줍니다.

- 원래 IP 주소는 호스트 인터페이스를 찾아갈 때 쓰는 것이고 포트 넘버는 호스트를 찾아가서 호스트 내부에서 프로세스를 찾아가는 것.
- ex) NAT를 사용하는 네트워크 내부에서 서버를 사용할 수 있을까?
    - 웹서버 80번 이용 가능? ⇒ 포트번호를 이미 사용해 어떤 프로세스를 지칭하는 지 알수가 없다.
- ex) a라우터에서 오는 IP 주소를 b라우터에 들어와서 나가는 정보를 저장해놓은 테이블이 NAT translation table 입니다.
- 포트번호도 바뀐다.
    - 같은 포트번호면 안되나? ⇒ 상관없음. 하지만 항상 같은 포트번호를 쓸 수 있을지 모른다.
- dest **port 번호**를 보고 어디로 보내야 할지를 결정합니다.
- 라우터의 역할은 IP 패킷 Header 에서 dest IP 주소를 변경했고 TCP 세그먼트 Header의 source IP 주소를 변경함. (라우터가 패킷의 데이터를 열어 그 안의 정보를 고치는 것이 별로임.)

### Practical Objections Against NAT

1. 예를 들어 같은 내부네트워크에 속하는, IP주소가 10.0.0.1 인 A와 10.0.0.2인 B가 포트번호가 80번인 서버를 운영하고 싶다고 가정하자.
2. 위는 불가능하다. 둘다 80번을 운영하고 싶은데 외부에서 포트번호 80으로 들어오면 어디로 보내야 할지를 모름.
3. 외부에서 패킷이 들어올 때 어떤 호스트로 패킷을 보낼 지는 원래 목적지 IP 주소를 가지고 정해야 하지만 NAT는 포트 번호를 통해 정하기 때문.

### DHCP (Dynamic Host Configuration Protocol)

- 무조건 모든 사람에게 IP 주소를 준다. ⇒ 낭비해야 하는 주소가 많음.
- 낭비가 심하니 다른 방법 사용. 그것이 DHCP
    1. DHCP discover
        1. source IP : 0.0.0.0. 68 ⇒ 클라이언트는 68번 포트 서버는 67번 포트 사용
        2. dest IP : 255.255.255.255.67 ⇒ 브로드캐스트 주소를 사용해 서브넷 내부 전체에 알려줌.
            1. 서버가 계속 헤더를 열어보면서 열려있는지 판단해 걸러냄.
        3. yiaddr : 0.0.0.0
        4. transaction ID : 654
    2. DHCP offer
        1. source IP : 223.1.2.5.67 ⇒ 서버의 주소
        2. dest : 255.255.255.255.68 ⇒ 또 브로드 캐스트 주소로 보냄. 이는 transaction ID를 통해 구분 가능.
        3. yiaddrr : 223.1.2.4 ⇒ 사용할 수 있는 IP 주소를 보내주는 것.
        4. transaction ID : 654
        5. lifetime : 3600secs
    3. DHCP request (DHCP로 부터 받은 offer를 정식으로 사용한다고 보내는 것.)
        1. source IP : 0.0.0.0. 68
        2. dest:: 255.255.255.255. 67
        3. yiaddrr: 223.1.2.4
        4. transaction ID : 655
        5. lifetime : 3600 seces
    4. DHCP ACK 
        1. source IP : 223.1.2.5. 67
        2. dest: 255.255.255.255. 68
        3. yiaddrr: 223.1.2.4
        4. transaction ID : 655
        5. lifetime : 3600 secs
        
- 마지막 ACK를 받기 전까지는 IP 주소가 없는 것임.
- DHCP는 host에게 중요한 정보 3가지를 제공해준다.
    1. IP address, subnet mask ⇒ 내가 인터넷을 사용하기 위해 IP 주소, 이것을 DHCP를 통해 받아옴.
    2. GateWay Router IP address ⇒ 내 첫번째 게이트웨이의 IP 주소, 패킷을 전달할 것인데 바로 다음 홉이 누군지 알아야하기 때문에 필요.
    3. Local Network Server IP address ⇒ 이걸 알아야 웹브라우저에 host name만 쳐도 IP주소로 변환