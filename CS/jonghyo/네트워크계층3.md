# 네트워크 계층3

## IP : Internet Protocol

- 내가 어떤 서브넷에 속해 있냐에 따라서 IP주소가 바뀜.

### Datagram format

- 다른 계층은 다 골라 쓸 수 있지만 IP는 골라 쓸 수 없다.
- data에는 대부분 TCP 또는 UCP 세그먼트가 들어갑니다.
- 실제 애플리케이션 메시지에 40바이트를 보낸다고 생각.(TCP 헤더에 20바이트 IP 헤더 20바이트)

### IP Fragment, reassembly

- 각 링크마다 특성이 있어 한번 최대 보내는데 크기의 제약이 있다.
- 만약 5000바이트짜리 패킷을 보내야 하는데 링크의 최대 크기가 1500이라면?
    - 가능한 패킷의 크기 만큼 잘라서 보내준다.(독립적인 패킷이 됌.)
    - 그러고 최종 목적지에서 다시 조립이 되어야함. ⇒ 조립이 되기 위해선 부가적인 정보가 필요함.
        - 위를 위해 필요한 것이 identifier 와 flag, fragment offset 이 부분 입니다.
        - ex) 4000바이트 짜리 패킷을 만듦. 이때 length = 4000, ID = x(랜덤값이라 생각) ,fragflag = 0, offset = 0입니다. 이것이 MTU가 1500인 링크를 만났다면?
            - length = 1500, ID = x, fragflag = 1, offset = 0 이 처음. (1500 꽉 채우고 ID는 같고(ID가 같다는 것은 원래 같은 패킷이라는 것을 의미함.)
             
            fragflag = 1로 바뀜 (이게 1이면? 내 이후에 다른 쪼개진 패킷이 있다는 소리.)
            
            offset은 내가 전체의 어디 부분에 해당하는지 좌표를 위치함.(제일 첫번째이므로 0번),
            - length = 1500, ID = x, fragflag = 1, offset = 185 이 다음. (실제 데이터의 헤더부분과 데이터 부분이 있다.
            
            offset이 185인 이유는 1500으로 처음 쪼갰는데 IP 패킷의 헤더가 20바이트를 차지하므로 1480번 데이터 이후이므로 1480 이후부터 시작하는데 /8 을 한 값을 써주기로 했다. /8을 한 이유는 비트수를 아끼기 위해서.
            - length = 1040, ID = x fragflag = 0, offset = 370 (마지막에 있는 패킷의 데이터의 시작점은? 1480이 2개 들어간 것. 그래서 370임.
            
            length가 1040인 이유는? ⇒ 원래 4000바이트 짜리 패킷은 헤더 20바이트 데이터 3980바이트 이다. 결국 헤더가 각자 다 20씩 붙고 맨 처음 데이터 1480, 두번째 1480, 세번째 1020이 되어서 1040이 되는 것입니다.
    - 만약 잘라진 것중에 하나가 오지 않는다면? ⇒ TCP 세그먼트라면 버려지고 다시 전부다 재전송할수도 있고 UDP라면 그냥 버릴수도 있고 다른 계층을 판단하면서 생각 해야함.

### ICMP (Internet control message protocol)

- 네트워크 내부에서 일어나는 여러가지 상황들에 의해서 라우터, 호스트 끼리 교신하기 위해 사용함.
- IP 패킷에 사용자의 데이터가 아닌 ICMP에 해당하는  ICMP메시지를 보내줍니다.

### IPv6

- IPv6보다 주소 공간의 확장 (32비트에서 128비트로)
- IPv6로 넘어간다면 중간에 IPv4와 공존하게 되는 순간이 있을 텐데 이때는 IPv6사이에 IPv4를 거쳐서 갈 수 있게 **터널링** 작업이 필요합니다.

### 라우터에서 하는일

- Fowarding = 패킷을 받아 Fowarding table을 참조해 어느 방향으로 보낼지 결정 후 보내주는 것.
- Routing = Fowarding 테이블을 만들어 놓는 것. (라우팅 알고리즘이 필요하다.)
    - link state 알고리즘
        - 다익스트라 알고리즘을 사용한다.
        - 가장 큰 특징으로는 목적지 까지 최단 거리를 계산하기 전에 모든 라우터들은 네트워크 상황을 알고있어야 한다. ⇒ 즉 사전에 브로드 캐스트를 해서 모든 정보를 가지고 있어야 함.